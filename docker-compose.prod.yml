version: '3.8'

# Sentinel â€” Production Configuration Reference
# Used as a reference for GCP Cloud Run service configs.
# Each service maps to a separate Cloud Run service.
#
# Deploy:
#   docker build -t gcr.io/<PROJECT>/sentinel-api -f sentinel-api/docker/Dockerfile.api sentinel-api/
#   docker build -t gcr.io/<PROJECT>/sentinel-slack -f sentinel-api/docker/Dockerfile.slack sentinel-api/
#   docker build -t gcr.io/<PROJECT>/sentinel-frontend \
#     --build-arg VITE_API_BASE_URL=https://api.yourdomain.com/api \
#     -f sentinel-frontend/docker/Dockerfile.frontend sentinel-frontend/
#   docker push gcr.io/<PROJECT>/sentinel-api
#   docker push gcr.io/<PROJECT>/sentinel-slack
#   docker push gcr.io/<PROJECT>/sentinel-frontend

services:

  api:
    image: gcr.io/${GCP_PROJECT}/sentinel-api:${IMAGE_TAG:-latest}
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: production
      PORT: 3000
      MONGODB_URI: ${MONGODB_URI}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRY: ${JWT_EXPIRY:-24h}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET}
      SLACK_CLIENT_ID: ${SLACK_CLIENT_ID}
      SLACK_CLIENT_SECRET: ${SLACK_CLIENT_SECRET}
      API_BASE_URL: ${API_BASE_URL}
    restart: unless-stopped

  slack-bot:
    image: gcr.io/${GCP_PROJECT}/sentinel-slack:${IMAGE_TAG:-latest}
    environment:
      NODE_ENV: production
      MONGODB_URI: ${MONGODB_URI}
      JWT_SECRET: ${JWT_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN}
      SLACK_CLIENT_ID: ${SLACK_CLIENT_ID}
      SLACK_CLIENT_SECRET: ${SLACK_CLIENT_SECRET}
      API_BASE_URL: ${API_BASE_URL}
    restart: unless-stopped

  frontend:
    image: gcr.io/${GCP_PROJECT}/sentinel-frontend:${IMAGE_TAG:-latest}
    ports:
      - '8080:8080'
    restart: unless-stopped
